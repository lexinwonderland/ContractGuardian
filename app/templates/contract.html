<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Contract</title>
	<link rel="stylesheet" href="/static/style.css" />
</head>
<body>
	<header>
		<h1>Contract</h1>
		<nav>
			<a href="/">Home</a>
			<a href="/contracts">Contracts</a>
			{% if user %}
				<a href="#" onclick="logout()">Logout</a>
			{% endif %}
		</nav>
	</header>
	<main>
		<div id="root">Loadingâ€¦</div>
	</main>
	<script>
	const root = document.getElementById('root');
	const id = location.pathname.split('/').pop();
	if (!/^\d+$/.test(id)) {
		// expected path: /contracts/view/{id}
		const parts = location.pathname.split('/');
		id = parts[parts.length - 1] || parts[parts.length - 2];
	}
	fetch(`/contracts/${id}`, { credentials: 'include' }).then(r=>r.json()).then(c => {
		root.innerHTML = renderContract(c);
		// Load GPT analysis if available
		loadGPTAnalysis(id);
	});
	function renderContract(c){
		const flags = (c.flags||[]).map(f => `
			<li class="flag ${f.severity}">
				<div class="flag-head"><strong>${f.category}</strong> <em>${f.severity}</em></div>
				<div class="excerpt">${escapeHtml(f.excerpt || '')}</div>
				<div class="explain">${escapeHtml(f.explanation)}</div>
				<div class="guide">${escapeHtml(f.guidance)}</div>
			</li>
		`).join('');
		const numFlags = (c.flags||[]).length;
		const fileUrl = c.stored_filename ? (`/contracts/file/${c.id}`) : null;
		const isImage = fileUrl && /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(c.stored_filename || '');
		const isPdf = fileUrl && /\.(pdf)$/i.test(c.stored_filename || '');
		const viewer = fileUrl ? (
			isImage ? `<img src="${fileUrl}" alt="Original upload" style="max-width:100%;height:auto;border:1px solid #ccc;border-radius:4px;" />` :
			isPdf ? `<iframe src="${fileUrl}" style="width:100%;height:70vh;border:1px solid #ccc;border-radius:4px;"></iframe>` :
			`<a href="${fileUrl}" target="_blank" rel="noopener">Open original file</a>`
		) : '';
		return `
			<div style="border:1px solid #e5e7eb;background:#f9fafb;border-radius:12px;padding:16px 20px">
			  <h2 style="margin:0;font-size:22px;font-weight:600;color:#111827">${escapeHtml(c.title)}</h2>
			  <p style="margin:6px 0 0 0;font-size:15px;line-height:1.6;color:#374151"><strong>Producer:</strong> ${escapeHtml(c.counterparty || '-')}
			   | <strong>Product/Production:</strong> ${escapeHtml(c.production || '-')}
			   | <strong>Date:</strong> ${c.contract_date || '-'} | <strong>Added:</strong> ${new Date(c.created_at).toLocaleString()}</p>
			</div>
			${fileUrl ? `<div style=\"border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:16px 20px;margin-top:16px\"><h3 style=\"margin:0 0 8px 0;font-size:18px;font-weight:600;color:#111827\">Original File</h3><div class=\"original\">${viewer}</div></div>` : ''}
			<h3 style="margin:16px 0 8px 0;font-size:18px;font-weight:600;color:#111827">Flags (${numFlags})</h3>
			${numFlags === 0 ? `
			<!-- All-clear alert (SAG style) -->
			<div role="status" aria-live="polite" style="border:1px solid #e5e7eb;background:#f9fafb;border-radius:12px;padding:16px 20px">
			  <div style="display:flex;gap:16px;align-items:flex-start">
			    <span style="margin-top:2px;display:inline-block;height:32px;width:6px;background:#FFC400;border-radius:3px"></span>
			    <div style="flex:1 1 auto">
			      <p style="margin:0 0 4px 0;font-size:18px;font-weight:600;color:#111827">All clear â€” No issues detected.</p>
			      <p style="margin:0;font-size:15px;line-height:1.6;color:#374151">
			        Language appears consistent with common, standard terms.
			        Please review the full document and, if needed, consult your representative
			        or legal counsel before signing.
			      </p>
			    </div>
			    <svg width="24" height="24" style="color:#4b5563;flex:0 0 auto" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
			      <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.707-9.707a1 1 0 0 0-1.414-1.414L9 10.172 7.707 8.879a1 1 0 1 0-1.414 1.414l2 2a1 1 0 0 0 1.414 0l4-4Z" clip-rule="evenodd"/>
			    </svg>
			  </div>
			</div>
			` : `
			<div style="border:1px solid #e5e7eb;background:#f9fafb;border-radius:12px;padding:16px 20px;margin-top:8px">
			  <ul class="flags" style="margin-top:0">${flags}</ul>
			</div>
			`}
			<div id="gpt-analysis-section" style="border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:16px 20px;margin-top:16px">
				<h3 style="margin:0 0 12px 0;font-size:18px;font-weight:600;color:#111827">AI Analysis</h3>
				<div id="gpt-analysis-content">
					<button id="analyze-gpt-btn" onclick="analyzeWithGPT(${c.id})" style="background:#3b82f6;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px">
						ðŸ¤– Analyze with GPT
					</button>
					<div id="gpt-loading" style="display:none;margin-top:12px;color:#6b7280">
						Analyzing contract with AI...
					</div>
					<div id="gpt-results" style="display:none;margin-top:12px"></div>
				</div>
			</div>
			<div style="border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:16px 20px;margin-top:16px">
				<details>
					<summary style="font-size:18px;font-weight:600;color:#111827">Full Text</summary>
					<pre class="contract-text" style="margin-top:12px">${escapeHtml(c.text)}</pre>
				</details>
			</div>
		`;
	}
	function escapeHtml(str){
		return (str||'').replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
	}
	async function logout() {
		const res = await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
		if (res.ok) {
			location.href = '/';
		}
	}
	
	async function loadGPTAnalysis(contractId) {
		try {
			const response = await fetch(`/contracts/${contractId}/gpt-analysis`, { credentials: 'include' });
			if (response.ok) {
				const analysis = await response.json();
				displayGPTAnalysis(analysis);
			}
		} catch (error) {
			console.log('No existing GPT analysis found');
		}
	}
	
	async function analyzeWithGPT(contractId) {
		const btn = document.getElementById('analyze-gpt-btn');
		const loading = document.getElementById('gpt-loading');
		const results = document.getElementById('gpt-results');
		
		btn.style.display = 'none';
		loading.style.display = 'block';
		results.style.display = 'none';
		
		try {
			const response = await fetch(`/contracts/${contractId}/analyze-gpt`, {
				method: 'POST',
				credentials: 'include'
			});
			
			if (response.ok) {
				const data = await response.json();
				displayGPTAnalysis(data.gpt_analysis);
			} else {
				const error = await response.json();
				results.innerHTML = `<div style="color:#dc2626;padding:12px;background:#fef2f2;border-radius:6px">Error: ${error.detail}</div>`;
				results.style.display = 'block';
			}
		} catch (error) {
			results.innerHTML = `<div style="color:#dc2626;padding:12px;background:#fef2f2;border-radius:6px">Error: ${error.message}</div>`;
			results.style.display = 'block';
		} finally {
			loading.style.display = 'none';
		}
	}
	
	function displayGPTAnalysis(analysis) {
		const results = document.getElementById('gpt-results');
		const btn = document.getElementById('analyze-gpt-btn');
		
		if (!analysis) return;
		
		const risks = (analysis.key_risks || []).map(risk => `
			<div style="margin-bottom:8px;padding:8px;background:#fef3c7;border-radius:4px">
				<strong>${escapeHtml(risk.risk || 'Risk')}</strong>
				<div style="font-size:14px;color:#92400e">${escapeHtml(risk.impact || '')}</div>
			</div>
		`).join('');
		
		const recommendations = (analysis.recommendations || []).map(rec => `
			<li style="margin-bottom:4px">${escapeHtml(rec)}</li>
		`).join('');
		
		results.innerHTML = `
			<div style="border:1px solid #d1d5db;background:#f9fafb;border-radius:8px;padding:16px">
				<h4 style="margin:0 0 12px 0;font-size:16px;font-weight:600;color:#111827">Summary</h4>
				<p style="margin:0 0 16px 0;line-height:1.6;color:#374151">${escapeHtml(analysis.summary)}</p>
				
				<h4 style="margin:0 0 12px 0;font-size:16px;font-weight:600;color:#111827">Key Risks</h4>
				<div style="margin-bottom:16px">${risks || '<p style="color:#6b7280;font-style:italic">No specific risks identified</p>'}</div>
				
				<h4 style="margin:0 0 12px 0;font-size:16px;font-weight:600;color:#111827">Recommendations</h4>
				<ul style="margin:0 0 16px 0;padding-left:20px;line-height:1.6;color:#374151">${recommendations || '<li style="color:#6b7280;font-style:italic">No specific recommendations</li>'}</ul>
				
				<h4 style="margin:0 0 12px 0;font-size:16px;font-weight:600;color:#111827">Overall Assessment</h4>
				<p style="margin:0;line-height:1.6;color:#374151">${escapeHtml(analysis.overall_assessment)}</p>
				
				<div style="margin-top:12px;padding-top:12px;border-top:1px solid #e5e7eb;font-size:14px;color:#6b7280">
					Confidence Score: ${Math.round((analysis.confidence_score || 0) * 100)}%
				</div>
			</div>
		`;
		
		results.style.display = 'block';
		btn.style.display = 'none';
	}
	</script>
</body>
</html> 