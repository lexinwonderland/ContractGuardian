<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Contract</title>
	<link rel="stylesheet" href="/static/style.css" />
</head>
<body>
	<header>
		<h1>Contract</h1>
		<nav>
			<a href="/">Home</a>
			<a href="/contracts">Contracts</a>
			{% if user %}
				<a href="#" onclick="logout()">Logout</a>
			{% endif %}
		</nav>
	</header>
	<main>
		<div id="root">Loading…</div>
	</main>
	<script>
	const root = document.getElementById('root');
	const id = location.pathname.split('/').pop();
	if (!/^\d+$/.test(id)) {
		// expected path: /contracts/view/{id}
		const parts = location.pathname.split('/');
		id = parts[parts.length - 1] || parts[parts.length - 2];
	}
	fetch(`/contracts/${id}`, { credentials: 'include' }).then(r=>r.json()).then(c => {
		root.innerHTML = renderContract(c);
	});
	function renderContract(c){
		const flags = (c.flags||[]).map(f => `
			<li class="flag ${f.severity}">
				<div class="flag-head"><strong>${f.category}</strong> <em>${f.severity}</em></div>
				<div class="excerpt">${escapeHtml(f.excerpt || '')}</div>
				<div class="explain">${escapeHtml(f.explanation)}</div>
				<div class="guide">${escapeHtml(f.guidance)}</div>
			</li>
		`).join('');
		const numFlags = (c.flags||[]).length;
		const fileUrl = c.stored_filename ? (`/contracts/file/${c.id}`) : null;
		const isImage = fileUrl && /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(c.stored_filename || '');
		const isPdf = fileUrl && /\.(pdf)$/i.test(c.stored_filename || '');
		const viewer = fileUrl ? (
			isImage ? `<img src="${fileUrl}" alt="Original upload" style="max-width:100%;height:auto;border:1px solid #ccc;border-radius:4px;" />` :
			isPdf ? `<iframe src="${fileUrl}" style="width:100%;height:70vh;border:1px solid #ccc;border-radius:4px;"></iframe>` :
			`<a href="${fileUrl}" target="_blank" rel="noopener">Open original file</a>`
		) : '';
		return `
			<div class="rounded-xl border border-gray-200 bg-gray-50 p-5 md:p-6">
			  <h2 class="text-xl font-semibold text-gray-900">${escapeHtml(c.title)}</h2>
			  <p class="mt-1 text-[15px] leading-relaxed text-gray-700"><strong>Producer:</strong> ${escapeHtml(c.counterparty || '-')}
			   | <strong>Product/Production:</strong> ${escapeHtml(c.production || '-')}
			   | <strong>Date:</strong> ${c.contract_date || '-'} | <strong>Added:</strong> ${new Date(c.created_at).toLocaleString()}</p>
			</div>
			${fileUrl ? `<div class="rounded-xl border border-gray-200 bg-white p-5 md:p-6" style="margin-top:16px"><h3 class="text-lg font-semibold text-gray-900" style="margin-top:0">Original File</h3><div class="original">${viewer}</div></div>` : ''}
			<h3 class="text-lg font-semibold text-gray-900" style="margin-top:16px">Flags (${numFlags})</h3>
			${numFlags === 0 ? `
			<!-- All-clear alert (SAG style) -->
			<div role="status" aria-live="polite"
			     class="rounded-xl border border-gray-200 bg-gray-50 p-5 md:p-6">
			  <div class="flex items-start gap-4">
			    <span class="mt-0.5 inline-block h-8 w-1.5 bg-[#FFC400] rounded-sm"></span>
			    <div class="flex-1">
			      <p class="text-lg font-semibold text-gray-900">
			        All clear — No issues detected.
			      </p>
			      <p class="mt-1 text-[15px] leading-relaxed text-gray-700">
			        Language appears consistent with common, standard terms.
			        Please review the full document and, if needed, consult your representative
			        or legal counsel before signing.
			      </p>
			    </div>
			    <!-- optional subtle check icon -->
			    <svg class="hidden md:block h-6 w-6 text-gray-600" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
			      <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.707-9.707a1 1 0 0 0-1.414-1.414L9 10.172 7.707 8.879a1 1 0 1 0-1.414 1.414l2 2a1 1 0 0 0 1.414 0l4-4Z" clip-rule="evenodd"/>
			    </svg>
			  </div>
			</div>
			` : `
			<div class="rounded-xl border border-gray-200 bg-gray-50 p-5 md:p-6" style="margin-top:8px">
			  <ul class="flags" style="margin-top:0">${flags}</ul>
			</div>
			`}
			<div class="rounded-xl border border-gray-200 bg-white p-5 md:p-6" style="margin-top:16px">
				<details>
					<summary class="text-lg font-semibold text-gray-900">Full Text</summary>
					<pre class="contract-text" style="margin-top:12px">${escapeHtml(c.text)}</pre>
				</details>
			</div>
		`;
	}
	function escapeHtml(str){
		return (str||'').replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
	}
	async function logout() {
		const res = await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
		if (res.ok) {
			location.href = '/';
		}
	}
	</script>
</body>
</html> 