<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Upload Contract</title>
	<link rel="stylesheet" href="/static/style.css" />
</head>
<body>
	<header>
		<h1>Upload Contract</h1>
		<nav>
			<a href="/">Home</a>
			<a href="/contracts">Contracts</a>
			{% if user %}
				<a href="#" onclick="logout()">Logout</a>
			{% endif %}
		</nav>
	</header>
	<main>
		<form id="uploadForm">
			<label>Title
				<input name="title" required />
			</label>
			<label>Product/Production
				<input name="production" />
			</label>
			<label>Producer
				<input name="counterparty" />
			</label>
			<label>Contract date
				<input name="contract_date" type="date" />
			</label>
			<label>File (PDF/Image/Text)
				<input name="file" type="file" accept=".pdf,image/*,text/plain" required />
			</label>
			<button type="submit">Upload & Analyze</button>
		</form>
		<div id="result"></div>
	</main>
	<script>
	const form = document.getElementById('uploadForm');
	const result = document.getElementById('result');
	form.addEventListener('submit', async (e) => {
		e.preventDefault();
		const fd = new FormData(form);
		result.innerHTML = 'Uploadingâ€¦';
		try {
			const res = await fetch('/contracts/upload', { method: 'POST', body: fd, credentials: 'include' });
			if (!res.ok) {
				const contentType = res.headers.get('content-type') || '';
				let bodyText = '';
				try { bodyText = await res.text(); } catch {}
				let detail = '';
				try {
					if (contentType.includes('application/json')) {
						const json = JSON.parse(bodyText || '{}');
						detail = json.detail || json.message || '';
					}
				} catch {}
				const safeBody = escapeHtml((detail || bodyText || '').slice(0, 800));
				const status = `${res.status} ${res.statusText}`;
				console.error('Upload failed', { status: res.status, statusText: res.statusText, contentType, bodyText });
				let hint = '';
				if (res.status === 401) hint = 'You may need to log in first.';
				else if (res.status === 400 && safeBody.includes('No text could be extracted')) hint = 'Try a clearer PDF/image, or upload a text file.';
				else if (res.status === 413) hint = 'File too large. Try a smaller file.';
				result.innerHTML = `
					<div class="error">
						<strong>Upload failed:</strong> ${status}<br/>
						${safeBody || 'No additional error details provided.'}
						${hint ? `<div class="hint">Hint: ${escapeHtml(hint)}</div>` : ''}
					</div>`;
				return;
			}
			const data = await res.json();
			result.innerHTML = renderContract(data);
		} catch (networkErr) {
			console.error('Network error during upload', networkErr);
			result.innerHTML = `<div class="error">Network error during upload. Please check your connection and try again.</div>`;
		}
	});

	function renderContract(c) {
		const flags = (c.flags || []).map(f => `
			<li class="flag ${f.severity}">
				<div class="flag-head"><strong>${f.category}</strong> <em>${f.severity}</em></div>
				<div class="excerpt">${escapeHtml(f.excerpt || '')}</div>
				<div class="explain">${escapeHtml(f.explanation)}</div>
				<div class="guide">${escapeHtml(f.guidance)}</div>
			</li>
		`).join('');
		return `
			<h2>${escapeHtml(c.title)}</h2>
			<p><strong>Producer:</strong> ${escapeHtml(c.counterparty || '-')}
			 | <strong>Product/Production:</strong> ${escapeHtml(c.production || '-')}
			 | <strong>Date:</strong> ${c.contract_date || '-'}</p>
			<h3>Flags (${(c.flags || []).length})</h3>
			<ul class="flags">${flags || '<li>No issues detected by automated scan.</li>'}</ul>
		`;
	}
	function escapeHtml(str){
		return (str||'').replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
	}
	async function logout() {
		const res = await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
		if (res.ok) {
			location.href = '/';
		}
	}
	</script>
</body>
</html> 